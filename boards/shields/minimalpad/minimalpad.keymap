#include <behaviors.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/rgb.h>
#include <dt-bindings/zmk/outputs.h>
#include <dt-bindings/gpio/gpio.h>

#define DEFAULT 0
#define LOWER   1

/ {
    sensors {
        compatible = "zmk,keymap-sensors";
        sensors = <&encoder0>;
        triggers-per-rotation = <20>;
    };

    // Define macros for layer-based RGB colors
    macros {
        rgb_default: rgb_default {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings = <&rgb_ug RGB_COLOR_HSB(140,70,50)>;
            label = "RGB_DEFAULT";
        };

        rgb_lower: rgb_lower {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings = <&rgb_ug RGB_COLOR_HSB(285,80,50)>;
            label = "RGB_LOWER";
        };

        // Bluetooth status indication macros
        bt_profile_1: bt_profile_1 {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings = <&bt BT_SEL 0 &rgb_ug RGB_COLOR_HSB(0,100,50)>; // Red
            label = "BT_PROFILE_1";
        };

        bt_profile_2: bt_profile_2 {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings = <&bt BT_SEL 1 &rgb_ug RGB_COLOR_HSB(30,100,50)>; // Orange
            label = "BT_PROFILE_2";
        };

        bt_profile_3: bt_profile_3 {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings = <&bt BT_SEL 2 &rgb_ug RGB_COLOR_HSB(60,100,50)>; // Yellow
            label = "BT_PROFILE_3";
        };

        bt_profile_4: bt_profile_4 {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings = <&bt BT_SEL 3 &rgb_ug RGB_COLOR_HSB(90,100,50)>; // Green
            label = "BT_PROFILE_4";
        };

        bt_clr_macro: bt_clr_macro {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings = <&bt BT_CLR &rgb_ug RGB_COLOR_HSB(210,100,80)>; // Blue for clearing
            label = "BT_CLEAR";
        };
    };

    // Define combo behavior to change RGB color when activating lower layer
    combos {
        compatible = "zmk,combos";
        combo_lower_layer {
            timeout-ms = <50>;
            key-positions = <15>; // Position of the lower layer key
            bindings = <&rgb_lower>;
            layers = <0>;
        };

        combo_default_layer {
            timeout-ms = <50>;
            key-positions = <15>; // Position of the lower layer key (when releasing)
            bindings = <&rgb_default>;
            layers = <1>;
        };
    };

    keymap {
        compatible = "zmk,keymap";

        default_layer {
            bindings = <
                &kp N7        &kp N8        &kp N9        &kp BSPC
                &kp N4        &kp N5        &kp N6        &kp PLUS
                &kp N1        &kp N2        &kp N3        &kp MINUS
                &kp N0        &kp DOT       &kp ENTER     &mo LOWER
                &kp C_MUTE                                           // Encoder button
            >;
            sensor-bindings = <&inc_dec_kp C_VOL_UP C_VOL_DN>;
        };

        lower_layer {
            bindings = <
                &rgb_ug RGB_TOG    &rgb_ug RGB_EFF    &rgb_ug RGB_BRI    &rgb_ug RGB_HUI
                &bt_profile_1      &bt_profile_2      &bt_profile_3      &bt_profile_4
                &bt_clr_macro      &out OUT_TOG       &out OUT_BLE       &out OUT_USB
                &bootloader        &sys_reset         &none              &trans
                &kp C_MUTE
            >;
            sensor-bindings = <&inc_dec_kp PG_UP PG_DN>;
        };
    };
};